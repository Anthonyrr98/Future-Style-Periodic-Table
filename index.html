<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®‡å®™çš„5%</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="bg-animation"></div>

    <div class="rotate-hint">ğŸ’¡ æ¨ªå±æŸ¥çœ‹æ•ˆæœæ›´ä½³</div>

    <div class="control-panel">
        <div class="title-box">
            <h1>å…ƒç´ å‘¨æœŸè¡¨</h1>
        </div>
        
        <div class="mode-group">
            <button class="mode-btn active" onclick="setMode('default')">æ ‡å‡†</button>
            <button class="mode-btn" onclick="setMode('radius')">åŠå¾„</button>
            <button class="mode-btn" onclick="setMode('en')">ç”µè´Ÿæ€§</button>
            <button class="mode-btn" onclick="setMode('ip')">ç”µç¦»èƒ½</button>
            <button class="mode-btn" onclick="setMode('melt')">ç†”ç‚¹</button>
            <button class="mode-btn" onclick="setMode('boil')">æ²¸ç‚¹</button>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æŸ¥æ‰¾å…ƒç´ ...">
        </div>
    </div>

    <div class="legend-wrapper">
        <div class="legend" id="legend"></div>
    </div>

    <div class="table-wrapper">
        <div class="periodic-table" id="table"></div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="hologram-card">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div class="atom-visualizer" id="atomWrapper">
                <div class="atom-container" id="atomContainer"></div>
                <div class="visualizer-hint">æ‹–æ‹½æ—‹è½¬è§†è§’</div>
            </div>
            <div class="info-panel">
                <div class="header-row">
                    <div class="big-symbol" id="m-symbol">Fe</div>
                    <div class="big-name"><span id="m-name">é“</span> <span id="m-en-name" style="font-size:16px;color:#666; margin-left:8px;">Iron</span></div>
                    <div class="category-tag" id="m-cat">è¿‡æ¸¡é‡‘å±</div>
                </div>

                <div class="config-box">
                    <label class="config-label">ç”µå­æ’å¸ƒ</label>
                    <div class="config-text" id="m-config-sub">1sÂ² 2sÂ² ...</div>
                    <div style="margin-top:6px; font-size:12px; color:#888" id="m-config-shell">æ¯å±‚: 2-8-14-2</div>
                </div>

                <div class="info-section">
                    <h3>å¸¸è§åŒ–åˆä»·</h3>
                    <div class="valence-tags" id="m-valence"></div>
                </div>

                <div class="info-section">
                    <h3>ç‰©ç†æ€§è´¨</h3>
                    <div class="props-grid">
                        <div class="prop-item"><label>åŸå­åºæ•°</label><span id="m-num">26</span></div>
                        <div class="prop-item"><label>ç›¸å¯¹åŸå­è´¨é‡</label><span id="m-mass">55.845</span></div>
                        <div class="prop-item"><label>åŸå­åŠå¾„ (pm)</label><span id="m-radius">126</span></div>
                        <div class="prop-item"><label>ç”µè´Ÿæ€§</label><span id="m-en">1.83</span></div>
                        <div class="prop-item"><label>ç”µç¦»èƒ½ (kJ/mol)</label><span id="m-ip">762.5</span></div>
                        <div class="prop-item"><label>ç†”ç‚¹ (K)</label><span id="m-melt">1811</span></div>
                        <div class="prop-item"><label>æ²¸ç‚¹ (K)</label><span id="m-boil">3134</span></div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>åŒä½ç´  (â— ç¨³å®š)</h3>
                    <div class="isotope-tags" id="m-isotopes"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
    <script src="data.js"></script>
    
    <!-- ä¸»é€»è¾‘ -->
    <script>
        const table = document.getElementById('table');
        const legend = document.getElementById('legend');
        let currentActiveCategory = null;

        // === è·å–å…ƒç´ åœ¨å‘¨æœŸè¡¨ä¸­çš„ä½ç½® ===
        function getPos(n) {
            if (n==1) return [1,1]; if (n==2) return [1,18];
            if (n>=3 && n<=4) return [2,n-2]; if (n>=5 && n<=10) return [2,n+8];
            if (n>=11 && n<=12) return [3,n-10]; if (n>=13 && n<=18) return [3,n];
            if (n>=19 && n<=36) return [4,n-18];
            if (n>=37 && n<=54) return [5,n-36];
            if (n>=55 && n<=56) return [6,n-54]; if (n>=72 && n<=86) return [6,n-68];
            if (n>=87 && n<=88) return [7,n-86]; if (n>=104 && n<=118) return [7,n-100];
            if (n>=57 && n<=71) return [9,n-53]; if (n>=89 && n<=103) return [10,n-85];
            return [0,0];
        }

        // === è®¡ç®—ç”µå­æ’å¸ƒ ===
        function getElectronData(Z) {
            let config = {};
            let remaining = Z;

            for (let orb of orbitals) {
                if (remaining <= 0) break;
                let type = orb.charAt(1);
                let cap = capacities[type];
                let fill = Math.min(remaining, cap);
                config[orb] = fill;
                remaining -= fill;
            }

            if (exceptions[Z]) {
                const patch = exceptions[Z];
                for (let orb in patch) {
                    config[orb] = patch[orb];
                }
            }

            const sortOrb = (a, b) => {
                let n1 = parseInt(a[0]), n2 = parseInt(b[0]);
                if(n1 !== n2) return n1 - n2;
                const order = "spdf";
                return order.indexOf(a[1]) - order.indexOf(b[1]);
            };

            const configStr = Object.keys(config)
                .filter(k => config[k] > 0)
                .sort(sortOrb)
                .map(k => `${k}<sup>${config[k]}</sup>`)
                .join(' ');

            let shells = [];
            Object.keys(config).forEach(orb => {
                let n = parseInt(orb[0]);
                shells[n-1] = (shells[n-1] || 0) + config[orb];
            });

            for(let i=0; i<shells.length; i++) { if(!shells[i]) shells[i]=0; }

            return { str: configStr, shells: shells };
        }

        // === åˆå§‹åŒ– ===
        function init() {
            // åˆ›å»ºå›¾ä¾‹
            categories.forEach((c, i) => {
                const btn = document.createElement('div');
                btn.className = 'legend-item';
                btn.innerHTML = `<div class="legend-color" style="background:${c.color}"></div>${c.name}`;
                btn.onclick = () => toggleCategory(i, btn);
                legend.appendChild(btn);
            });

            // åˆ›å»ºå…ƒç´ æ ¼å­
            elements.forEach((e, i) => {
                const [r, c] = getPos(e.idx);
                const el = document.createElement('div');
                el.className = 'element';
                el.style.gridRow = r;
                el.style.gridColumn = c;
                el.dataset.idx = e.idx;
                
                el.style.borderColor = e.cat.color;
                
                el.innerHTML = `
                    <div class="atomic-number">${e.idx}</div>
                    <div class="symbol" style="color:${e.cat.color}">${e.sym}</div>
                    <div class="name">${e.name}</div>
                    <div class="detail-val"></div>
                `;
                el.onclick = () => showModal(e);
                
                setTimeout(() => el.classList.add('visible'), i * 5);
                table.appendChild(el);
            });

            // åˆ›å»ºé•§ç³»/é”•ç³»å ä½ç¬¦
            const placeholders = [
                { row: 6, col: 3, sym: "57-71", name: "é•§ç³»", catIdx: 8, range: "La - Lu" },
                { row: 7, col: 3, sym: "89-103", name: "é”•ç³»", catIdx: 9, range: "Ac - Lr" }
            ];

            placeholders.forEach(p => {
                const el = document.createElement('div');
                el.className = 'element placeholder';
                el.style.gridRow = p.row;
                el.style.gridColumn = p.col;
                
                const color = categories[p.catIdx].color;
                el.style.borderColor = color;
                
                el.innerHTML = `
                    <div class="range-num" style="color:${color}">${p.sym}</div>
                    <div class="name">${p.name}</div>
                `;

                el.onclick = () => {
                   const btns = document.querySelectorAll('.legend-item');
                   if(btns[p.catIdx]) btns[p.catIdx].click();
                };

                setTimeout(() => el.classList.add('visible'), 600);
                table.appendChild(el);
            });

            initDragControl();
        }

        // === åˆ†ç±»åˆ‡æ¢ ===
        function toggleCategory(catId, btn) {
            if (document.querySelector('.periodic-table.heatmap-active')) {
                setMode('default');
            }

            const allElements = document.querySelectorAll('.element');
            const allBtns = document.querySelectorAll('.legend-item');

            if (currentActiveCategory === catId) {
                currentActiveCategory = null;
                allBtns.forEach(b => b.classList.remove('active'));
                allElements.forEach(el => {
                    el.style.opacity = '1';
                    el.style.filter = 'none';
                });
            } else {
                currentActiveCategory = catId;
                allBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                allElements.forEach(el => {
                    if(el.dataset.idx) {
                        const data = elements[el.dataset.idx - 1];
                        if (data.catId === catId) {
                            el.style.opacity = '1';
                            el.style.filter = 'none';
                        } else {
                            el.style.opacity = '0.1';
                            el.style.filter = 'grayscale(100%)';
                        }
                    }
                    else if (el.classList.contains('placeholder')) {
                        const phName = el.querySelector('.name').innerText;
                        const isRelated = (catId === 8 && phName === 'é•§ç³»') || (catId === 9 && phName === 'é”•ç³»');
                        
                        if(isRelated) {
                            el.style.opacity = '1';
                            el.style.background = 'rgba(255,255,255,0.1)';
                        } else {
                            el.style.opacity = '0.3';
                            el.style.background = 'transparent';
                        }
                    }
                });
            }
        }

        // === æ¨¡å¼åˆ‡æ¢ï¼ˆçƒ­åŠ›å›¾ç­‰ï¼‰ ===
        function setMode(mode) {
            currentActiveCategory = null;
            document.querySelectorAll('.legend-item').forEach(b => b.classList.remove('active'));

            const domElements = document.querySelectorAll('.element');
            const btns = document.querySelectorAll('.mode-btn');
            
            btns.forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setMode('${mode}')"]`).classList.add('active');

            if (mode === 'default') {
                table.classList.remove('heatmap-active');
                domElements.forEach(el => {
                    if(el.classList.contains('placeholder')) {
                        el.style.background = 'rgba(255,255,255,0.01)';
                        el.style.opacity = '1';
                        return;
                    }

                    const data = elements[el.dataset.idx - 1];
                    el.style.background = 'var(--card-bg)';
                    el.style.borderColor = data.cat.color;
                    el.querySelector('.symbol').style.color = data.cat.color;
                    el.style.opacity = '1';
                    el.style.filter = 'none';
                });
                return;
            }

            table.classList.add('heatmap-active');

            let maxVal = -Infinity, minVal = Infinity;
            elements.forEach(e => {
                let val = e[mode];
                if (val > 0) {
                    if (val > maxVal) maxVal = val;
                    if (val < minVal) minVal = val;
                }
            });

            domElements.forEach(el => {
                if(el.classList.contains('placeholder')) {
                    el.style.opacity = '0.1';
                    return;
                }

                const data = elements[el.dataset.idx - 1];
                const val = data[mode];
                const displayDiv = el.querySelector('.detail-val');
                
                el.style.opacity = '1';
                el.style.filter = 'none';
                
                if (val === 0) {
                    el.style.background = '#222';
                    el.style.borderColor = '#444';
                    displayDiv.innerText = '-';
                } else {
                    let ratio = (val - minVal) / (maxVal - minVal);
                    let hue = 240 - (ratio * 240); 
                    el.style.background = `hsla(${hue}, 70%, 40%, 0.8)`;
                    el.style.borderColor = `hsla(${hue}, 100%, 70%, 1)`;
                    el.querySelector('.symbol').style.color = '#fff';
                    displayDiv.innerText = val;
                }
            });
        }

        // === å¼¹çª—ç›¸å…³ ===
        const modal = document.getElementById('modal');
        const atomContainer = document.getElementById('atomContainer');

        function render3DAtom(Z) {
            atomContainer.innerHTML = '';
            
            const nucleus = document.createElement('div');
            nucleus.className = 'nucleus';
            atomContainer.appendChild(nucleus);

            const { shells } = getElectronData(Z);
            
            shells.forEach((count, idx) => {
                if (count === 0) return;
                const isValence = (idx === shells.length - 1);
                const size = 40 + (idx * 25);
                
                const orbit = document.createElement('div');
                orbit.className = 'orbit-ring';
                orbit.style.width = `${size}px`; 
                orbit.style.height = `${size}px`;
                orbit.style.top = `calc(50% - ${size/2}px)`; 
                orbit.style.left = `calc(50% - ${size/2}px)`;
                
                const rx = Math.random()*360, ry = Math.random()*360;
                orbit.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
                
                const animDuration = 5 + idx * 2;
                orbit.animate([
                    { transform: `rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(0deg)` },
                    { transform: `rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(360deg)` }
                ], {
                    duration: animDuration * 1000,
                    iterations: Infinity,
                    easing: 'linear'
                });

                for(let i=0; i<count; i++) {
                    const electron = document.createElement('div');
                    electron.className = `electron ${isValence ? 'valence' : 'inner'}`;
                    const angle = (360/count) * i;
                    electron.style.transform = `rotate(${angle}deg) translateX(${size/2}px)`;
                    orbit.appendChild(electron);
                }
                atomContainer.appendChild(orbit);
            });
            return shells;
        }

        // === æ‹–æ‹½æ§åˆ¶ ===
        let rotX = 0;
        let rotY = 0;
        let isDragging = false;
        let lastMouseX, lastMouseY;

        function initDragControl() {
            const wrapper = document.getElementById('atomWrapper');

            wrapper.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                
                rotY += dx * 0.5;
                rotX -= dy * 0.5;

                atomContainer.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            });

            window.addEventListener('mouseup', () => isDragging = false);

            wrapper.addEventListener('touchstart', (e) => {
                isDragging = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
            }, { passive: true });

            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - lastMouseX;
                const dy = e.touches[0].clientY - lastMouseY;
                
                rotY += dx * 0.8;
                rotX -= dy * 0.8;

                atomContainer.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
                
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
            }, { passive: true });

            window.addEventListener('touchend', () => isDragging = false);
        }

        function showModal(data) {
            rotX = 0; 
            rotY = 0;
            atomContainer.style.transform = `rotateX(0deg) rotateY(0deg)`;

            document.getElementById('m-symbol').innerText = data.sym;
            document.getElementById('m-symbol').style.color = data.cat.color;
            document.getElementById('m-name').innerText = data.name;
            document.getElementById('m-en-name').innerText = data.enName;
            document.getElementById('m-cat').innerText = data.cat.name;
            document.getElementById('m-cat').style.borderColor = data.cat.color;
            document.getElementById('m-cat').style.color = data.cat.color;
            
            document.getElementById('m-num').innerText = data.idx;
            document.getElementById('m-mass').innerText = data.mass;
            document.getElementById('m-melt').innerText = data.melt || "â€”";
            document.getElementById('m-boil').innerText = data.boil || "â€”";
            document.getElementById('m-radius').innerText = data.radius || "â€”";
            document.getElementById('m-en').innerText = data.en || "â€”";
            document.getElementById('m-ip').innerText = data.ip || "â€”";

            const valenceContainer = document.getElementById('m-valence');
            valenceContainer.innerHTML = '';
            if (data.valence && data.valence.length > 0) {
                data.valence.forEach(v => {
                    const tag = document.createElement('span');
                    tag.className = 'valence-tag';
                    tag.textContent = v;
                    valenceContainer.appendChild(tag);
                });
            } else {
                valenceContainer.innerHTML = '<span style="color:#666">æš‚æ— æ•°æ®</span>';
            }

            const isotopeContainer = document.getElementById('m-isotopes');
            isotopeContainer.innerHTML = '';
            if (data.isotopes && data.isotopes.length > 0) {
                data.isotopes.forEach(iso => {
                    const tag = document.createElement('span');
                    tag.className = `isotope-tag ${iso.s ? 'isotope-stable' : ''}`;
                    tag.innerHTML = `<span class="mass-num">${iso.m}</span>${data.sym}${iso.s ? ' â—' : ''}`;
                    isotopeContainer.appendChild(tag);
                });
            } else {
                isotopeContainer.innerHTML = '<span style="color:#666">æš‚æ— æ•°æ®</span>';
            }

            const eData = getElectronData(data.idx);
            document.getElementById('m-config-sub').innerHTML = eData.str;
            document.getElementById('m-config-shell').innerText = `åˆ†å±‚: ${eData.shells.join(' - ')}`;

            render3DAtom(data.idx);
            modal.classList.add('open');
            
            // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.remove('open');
            document.body.style.overflow = '';
            setTimeout(() => atomContainer.innerHTML = '', 300);
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // === æœç´¢åŠŸèƒ½ ===
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            
            document.querySelectorAll('.element').forEach(el => {
                let match = false;

                if (el.classList.contains('placeholder')) {
                    const textContent = el.innerText.toLowerCase();
                    match = textContent.includes(val);
                } 
                else if (el.dataset.idx) {
                    const d = elements[el.dataset.idx - 1];
                    match = d.name.includes(val) || 
                            d.sym.toLowerCase().includes(val) || 
                            String(d.idx) === val || 
                            d.enName.toLowerCase().includes(val);
                }

                if (val === '') {
                    el.style.opacity = '1';
                    el.style.filter = 'none';
                } else {
                    el.style.opacity = match ? '1' : '0.1';
                    el.style.filter = match ? 'none' : 'grayscale(100%)';
                }
            });
        });
        
        // === é”®ç›˜äº‹ä»¶ ===
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // === å¯åŠ¨ ===
        init();
    </script>
</body>
</html>